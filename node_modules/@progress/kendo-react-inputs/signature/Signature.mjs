/**
 * @license
 *-------------------------------------------------------------------------------------------
 * Copyright Â© 2024 Progress Software Corporation. All rights reserved.
 * Licensed under commercial license. See LICENSE.md in the package root for more information
 *-------------------------------------------------------------------------------------------
 */
"use client";
import { SignaturePad as Oe } from "@progress/kendo-inputs-common";
import { Button as T } from "@progress/kendo-react-buttons";
import { createPropsContext as xe, validatePackage as Me, usePropsContext as we, useIsomorphicLayoutEffect as Le, dispatchEvent as h, classNames as B, kendoThemeMaps as ee, getTabIndex as Ie, noop as p } from "@progress/kendo-react-common";
import { Dialog as Pe } from "@progress/kendo-react-dialogs";
import { useLocalization as De } from "@progress/kendo-react-intl";
import a from "prop-types";
import * as o from "react";
import { signatureMaximize as te, messages as R, signatureMinimize as oe, signatureClear as ne } from "../messages/index.mjs";
import { packageMetadata as Te } from "../package-metadata.mjs";
import { hasParent as Be } from "./utils/index.mjs";
import { hyperlinkOpenIcon as ae, xIcon as Re } from "@progress/kendo-svg-icons";
const Fe = 250, _e = 84, ie = 3, le = 2, Ne = "#000000", qe = "#ffffff", re = (d) => d !== void 0, Ge = xe(), F = o.forwardRef((d, se) => {
  Me(Te);
  const _ = we(Ge, d), e = o.useMemo(
    () => ({
      strokeWidth: l.strokeWidth,
      smooth: l.smooth,
      popupScale: l.popupScale,
      exportScale: l.exportScale,
      maximizable: l.maximizable,
      disabled: l.disabled,
      required: l.required,
      validityStyles: l.validityStyles,
      onChange: l.onChange,
      onFocus: l.onFocus,
      onBlur: l.onBlur,
      onOpen: l.onOpen,
      onClose: l.onClose,
      size: l.size,
      rounded: l.rounded,
      fillMode: l.fillMode,
      ..._
    }),
    [_]
  ), z = De(), c = o.useRef(null), g = o.useRef(null), N = o.useRef(null), q = o.useRef(null), S = o.useRef(null), [r, ce] = o.useState(), [b, G] = o.useState(!1), [E, W] = o.useState(!1), [k, A] = o.useState(), [ue, de] = o.useState(), V = re(e.value) ? e.value : k, [me, fe] = o.useState(!1), f = re(e.open), m = f ? e.open : me, pe = e.maximized || E || !e.maximizable || e.disabled, ge = !(e.maximized && !E), be = !(!(e.value || k) || E || e.readOnly || e.disabled), j = z.toLanguageString(te, R[te]), U = z.toLanguageString(oe, R[oe]), H = z.toLanguageString(ne, R[ne]), O = e.popupScale || ie, x = e.exportScale || le, M = (t) => {
    A(t), e.onChange && e.onChange({ value: t });
  }, ke = (t) => {
    r == null || r.loadImage(t.value), M(t.value);
  };
  o.useEffect(() => {
    e.value !== k && (A(e.value), r == null || r.loadImage(e.value));
  }, [e.value]);
  const ye = () => {
    r == null || r.clear(), M();
  }, y = o.useCallback(
    (t) => {
      f || fe(t);
    },
    [f]
  ), ve = (t) => {
    var n, i;
    Q(t), (i = ((n = S.current) == null ? void 0 : n.element) || g.current) == null || i.focus();
  }, w = o.useCallback(() => {
    let t = Ne;
    return !e.color && typeof document != "undefined" && c.current && (t = getComputedStyle(c.current).color), e.color || t;
  }, [e.color]), L = o.useCallback(() => {
    let t = qe;
    return !e.backgroundColor && typeof document != "undefined" && c.current && (t = getComputedStyle(c.current).backgroundColor), e.backgroundColor || t;
  }, [e.backgroundColor]), $ = () => ({
    scale: e.maximized ? e.popupScale : 1,
    color: w(),
    backgroundColor: L(),
    strokeWidth: e.strokeWidth,
    smooth: e.smooth,
    readonly: e.readOnly
  }), K = async (t) => {
    const { width: n, height: i } = t;
    return await (r == null ? void 0 : r.exportImage({
      width: n * x,
      height: i * x
    }));
  };
  o.useEffect(() => {
    const t = g.current, n = new Oe(t, $());
    return V && n.loadImage(V), ce(n), () => n.destroy();
  }, []), o.useEffect(() => {
    r == null || r.setOptions({
      onChange: async () => M(await K(Y())),
      onDraw: () => W(!0),
      onDrawEnd: () => W(!1)
    });
  }, [r]), Le(
    () => r == null ? void 0 : r.setOptions($()),
    [e.readOnly, e.color, e.backgroundColor, e.strokeWidth, e.smooth]
  ), o.useEffect(() => {
    var i, s;
    const t = (s = (i = N.current) == null ? void 0 : i.element) == null ? void 0 : s.querySelector(".k-overlay");
    if (!t)
      return;
    const n = () => y(!1);
    return t.addEventListener("click", n), () => t.removeEventListener("click", n);
  }, [m]), o.useEffect(() => {
    if (!m || typeof document == "undefined")
      return;
    const t = (n) => {
      var i, s;
      n.key === "Escape" && (y(!1), (s = (i = S.current) == null ? void 0 : i.element) == null || s.focus());
    };
    return document.addEventListener("keydown", t), () => document.removeEventListener("keydown", t);
  }, [m]), o.useEffect(() => {
    var t, n;
    e.maximized && ((n = (t = q.current) == null ? void 0 : t.element) == null || n.focus());
  }, []);
  const I = o.useCallback(() => {
    var t;
    return (t = g.current) == null ? void 0 : t.focus();
  }, []), v = o.useCallback(() => e.value, [e.value]), X = o.useCallback(() => e.name, [e.name]), C = o.useCallback(() => e.required, [e.required]), P = o.useCallback(() => {
    const t = e.validationMessage !== void 0, i = !v(), s = e.valid !== void 0 ? e.valid : !C() || !i;
    return {
      customError: t,
      valid: s,
      valueMissing: i
    };
  }, [e.validationMessage, e.valid, v, C]), D = o.useCallback(() => e.validityStyles, [e.validityStyles]), J = o.useCallback(() => e, [e]), u = o.useCallback(() => {
    const t = {
      element: c.current,
      focus: I
    };
    return Object.defineProperty(t, "name", { get: X }), Object.defineProperty(t, "value", { get: v }), Object.defineProperty(t, "validity", { get: P }), Object.defineProperty(t, "validityStyles", { get: D }), Object.defineProperty(t, "required", { get: C }), Object.defineProperty(t, "props", { get: J }), Object.defineProperty(t, "color", { get: w }), Object.defineProperty(t, "backgroundColor", { get: L }), t;
  }, [
    X,
    v,
    P,
    D,
    C,
    I,
    J,
    w,
    L
  ]);
  o.useImperativeHandle(se, u);
  const Ce = o.useCallback(
    (t) => {
      b || e.maximized || (G(!0), h(e.onFocus, t, u(), {}));
    },
    [b, e.onFocus, u]
  ), he = o.useCallback(
    (t) => {
      Be(t.relatedTarget, c.current) || (G(!1), h(e.onBlur, t, u(), {}));
    },
    [b, e.onBlur, u]
  ), ze = o.useCallback(
    async (t) => {
      de(await K(Z())), y(!0), h(e.onOpen, t, u(), {});
    },
    [m, f, e.onOpen, e.value, k, u]
  ), Q = o.useCallback(
    (t) => {
      y(!1), h(e.onClose, t, u(), {});
    },
    [m, f, e.onClose, u]
  ), Se = () => {
    ye(), I();
  }, Y = () => {
    var i, s;
    const t = e.width || ((i = c.current) == null ? void 0 : i.offsetWidth) || Fe, n = e.height || ((s = c.current) == null ? void 0 : s.offsetHeight) || _e;
    return {
      width: t,
      height: n
    };
  }, Z = () => {
    const { width: t, height: n } = Y();
    return {
      width: t * O,
      height: n * O
    };
  }, Ee = !D() || P().valid;
  return /* @__PURE__ */ o.createElement(
    "div",
    {
      ref: c,
      dir: e.dir,
      style: { width: e.width, height: e.height, ...e.style },
      className: B(
        "k-input",
        "k-signature",
        {
          "k-signature-maximized": e.maximized,
          [`k-signature-${ee.sizeMap[e.size] || e.size}`]: e.size,
          [`k-signature-${e.fillMode}`]: e.fillMode,
          [`k-input-${e.fillMode}`]: e.fillMode,
          [`k-rounded-${ee.roundedMap[e.rounded] || e.rounded}`]: e.rounded,
          "k-invalid": !Ee,
          "k-required": e.required,
          "k-disabled": e.disabled,
          "k-focus": b
        },
        e.className
      ),
      onFocus: Ce,
      onBlur: he
    },
    /* @__PURE__ */ o.createElement(
      "div",
      {
        className: "k-signature-canvas",
        ref: g,
        tabIndex: Ie(e.tabIndex, e.disabled),
        role: "img",
        id: e.id,
        "aria-label": e.ariaLabel,
        "aria-labelledby": e.ariaLabelledBy,
        "aria-describedby": e.ariaDescribedBy,
        "aria-disabled": e.disabled ? "true" : void 0
      }
    ),
    /* @__PURE__ */ o.createElement("div", { className: "k-signature-actions k-signature-actions-top" }, /* @__PURE__ */ o.createElement(
      T,
      {
        type: "button",
        className: B("k-signature-action", "k-signature-maximize", {
          "k-hidden": e.disabled || pe
        }),
        ref: S,
        icon: "hyperlink-open",
        svgIcon: ae,
        fillMode: "flat",
        size: e.size,
        onClick: ze,
        "aria-label": j,
        title: j
      }
    ), /* @__PURE__ */ o.createElement(
      T,
      {
        type: "button",
        className: B("k-signature-action", "k-signature-minimize", "k-rotate-180", {
          "k-hidden": e.disabled || ge
        }),
        ref: q,
        icon: "hyperlink-open",
        svgIcon: ae,
        fillMode: "flat",
        size: e.size,
        onClick: Q,
        "aria-label": U,
        title: U
      }
    )),
    !e.hideLine && /* @__PURE__ */ o.createElement("div", { className: "k-signature-line", style: { zIndex: 2, pointerEvents: "none" } }),
    /* @__PURE__ */ o.createElement("div", { className: "k-signature-actions k-signature-actions-bottom" }, be && /* @__PURE__ */ o.createElement(
      T,
      {
        type: "button",
        className: "k-signature-action k-signature-clear",
        icon: "x",
        svgIcon: Re,
        fillMode: "flat",
        size: e.size,
        onClick: Se,
        "aria-label": H,
        title: H
      }
    )),
    m && /* @__PURE__ */ o.createElement(Pe, { ref: N }, /* @__PURE__ */ o.createElement(
      F,
      {
        ...e,
        ...Z(),
        value: ue,
        maximized: !0,
        exportScale: 1 / O * x,
        open: !1,
        onChange: ke,
        onClose: ve
      }
    ))
  );
});
F.propTypes = {
  value: a.string,
  width: a.number,
  height: a.number,
  tabIndex: a.number,
  dir: a.string,
  ariaDescribedBy: a.string,
  ariaLabelledBy: a.string,
  ariaLabel: a.string,
  readOnly: a.bool,
  disabled: a.bool,
  validationMessage: a.string,
  required: a.bool,
  onChange: a.func,
  onFocus: a.func,
  onBlur: a.func,
  onOpen: a.func,
  onClose: a.func,
  size: a.oneOf([null, "small", "medium", "large"]),
  rounded: a.oneOf([null, "small", "medium", "large"]),
  fillMode: a.oneOf([null, "solid", "flat", "outline"])
};
const l = {
  strokeWidth: 1,
  smooth: !1,
  popupScale: ie,
  exportScale: le,
  maximizable: !0,
  disabled: !1,
  required: !1,
  validityStyles: !0,
  onChange: (d) => p,
  onFocus: (d) => p,
  onBlur: (d) => p,
  onOpen: (d) => p,
  onClose: (d) => p,
  size: "medium",
  rounded: "medium",
  fillMode: "solid"
};
F.displayName = "KendoSignature";
export {
  F as Signature,
  Ge as SignaturePropsContext
};
